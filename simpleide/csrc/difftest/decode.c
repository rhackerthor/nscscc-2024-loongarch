#include <difftest/decode.h>
#include <difftest/ref.h>

static enum {
  TYPE_R, TYPE_UI5, TYPE_UI12, TYPE_SI12,
  TYPE_SI16, TYPE_SI20, TYPE_SI26
};

/* memory */
#define Mread(vaddr) pmem_read(ref_pmem, vaddr)
#define Mwrite(vaddr, data, mask) pmem_write(ref_pmem, vaddr, data, mask)

/* reg */
#define src1R() do { *src1 = ref_gpr(rj); } while (0)
#define src2R() do { *src2 = ref_gpr(rk); } while (0)

/* immediate */
#define UIMM5()  do { *imm = BITS(i, 19, 15); } while (0)
#define UIMM12() do { *imm = BITS(i, 21, 10); } while (0)
#define SIMM12() do { *imm = SEXT(BITS(i, 21, 10), 12); } while (0)
#define SIMM16() do { *imm = SEXT(BITS(i, 25, 10), 16); } while (0)
#define SIMM20() do { *imm = SEXT(BITS(i, 24, 5), 20) << 12; } while (0)
#define SIMM26() do { *imm = (SEXT(BITS(i, 9, 0), 10) << 16) | BITS(i, 25, 10); } while (0)

static void decode_operand(int *rd, word_t *src1, word_t *src2, word_t *imm, state_t type) {
  word_t i = ref_cpu.inst;
  *rd     = BITS(i,  4,  0);
  int rj  = BITS(i,  9,  5);
  int rk  = BITS(i, 14, 10);
  switch (type) {
    case TYPE_R   : src1R(); src2R();           break;
    case TYPE_UI5 : src1R();          UIMM5();  break;
    case TYPE_UI12: src1R();          UIMM12(); break;
    case TYPE_SI12: src1R();          SIMM12(); break;
    case TYPE_SI16: src1R();          SIMM16(); break;
    case TYPE_SI20:                   SIMM20(); break;
    case TYPE_SI26:                   SIMM26(); break;
    default: break;
  }
}

word_t ref_decoder_execute() {
  int rd = 0;
  word_t src1 = 0, src2 = 0, imm = 0;

#define INSTPAT_INST() (ref_cpu.inst)
#define INSTPAT_MATCH(name, type, ... /* execute body */ ) { \
  decode_operand(&rd, &src1, &src2, &imm, concat(TYPE_, type)); \
  __VA_ARGS__ ; \
}

  INSTPAT_START();

  INSTPAT("00000000000100000???????????????", add_w     , R    , ref_gpr(rd) = src1 + src2);
  INSTPAT("00000000000100010???????????????", sub_w     , R    , ref_gpr(rd) = src1 - src2);
  INSTPAT("00000000000101001???????????????", and       , R    , ref_gpr(rd) = src1 & src2);
  INSTPAT("00000000000101010???????????????", or        , R    , ref_gpr(rd) = src1 | src2);
  INSTPAT("00000000000101011???????????????", xor       , R    , ref_gpr(rd) = src1 ^ src2);
  INSTPAT("00000000000111000???????????????", mul_w     , R    , ref_gpr(rd) = src1 * src2);

  INSTPAT("00000000010010001???????????????", srai_w    , UI5  , ref_gpr(rd) = src1 >> BITS(imm, 4, 0));
  INSTPAT("00000000010001001???????????????", srli_w    , UI5  , ref_gpr(rd) = (signed)src1 >> BITS(imm, 4, 0));
  INSTPAT("00000000010000001???????????????", slli_w    , UI5  , ref_gpr(rd) = src1 << BITS(imm, 4, 0));

  INSTPAT("0000001001??????????????????????", sltui     , SI12 , ref_gpr(rd) = src1 < imm ? 1 : 0);
  INSTPAT("0000001010??????????????????????", addi_w    , SI12 , ref_gpr(rd) = src1 + imm);
  INSTPAT("0000001101??????????????????????", andi      , UI12 , ref_gpr(rd) = src1 & imm);
  INSTPAT("0000001110??????????????????????", ori       , UI12 , ref_gpr(rd) = src1 | imm);

  INSTPAT("0010100000??????????????????????", ld_b      , SI12 , ref_gpr(rd) = SEXT(Mread(src1 + imm), 8));
  INSTPAT("0010100010??????????????????????", ld_w      , SI12 , ref_gpr(rd) = Mread(src1 + imm));

  INSTPAT("0010100100??????????????????????", st_b      , SI12 , Mwrite(src1 + imm, ref_gpr(rd), 1 << BITS(src1 + imm, 1, 0)));
  INSTPAT("0010100110??????????????????????", st_w      , SI12 , Mwrite(src1 + imm, ref_gpr(rd), 0xf));

  INSTPAT("0001010?????????????????????????", lu12i_w   , SI20 , ref_gpr(rd) = imm);
  INSTPAT("0001110?????????????????????????", pcaddu12i , SI20 , ref_gpr(rd) = ref_pc + imm);

  INSTPAT("010011??????????????????????????", jirl      , SI16 , ref_gpr(rd) = ref_pc + 4, ref_next_pc = src1 + imm);
  INSTPAT("010100??????????????????????????", b         , SI26 , ref_next_pc = ref_pc + imm);
  INSTPAT("010101??????????????????????????", bl        , SI26 , ref_gpr(1)  = ref_pc + 4, ref_next_pc = ref_pc + imm);

  INSTPAT("010110??????????????????????????", beq       , SI16 , ref_next_pc = (src1 == src2) ? ref_next_pc + imm : ref_next_pc);
  INSTPAT("010111??????????????????????????", bne       , SI16 , ref_next_pc = (src1 != src2) ? ref_next_pc + imm : ref_next_pc);
  INSTPAT("011001??????????????????????????", bge       , SI16 , ref_next_pc = (src1 >= src2) ? ref_next_pc + imm : ref_next_pc);

  INSTPAT_END();


}